(function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;Function.prototype.inheritFrom=function(a){var b=new a;this.prototype=b},a.report=function(a){throw new Error(a?a:"Something went wrong")},a.byId=function(a){return function(b){return b.id===a}},a.randomInt=function(a,b){return Math.floor(Math.random()*(b-a+1))+a},a.randomColor=function(){var b="rgb(";for(var c=0;c<3;c+=1)b+=a.randomInt(0,255)+",";return b.substring(0,b.length-2)+")"}})(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.EventEmitter=function(){this.listeners={}},a.EventEmitter.prototype.on=function(a,b){this.listeners[a]instanceof Array||(this.listeners[a]=[]),this.listeners[a].indexOf(b)===-1&&this.listeners[a].push(b)},a.EventEmitter.prototype.off=function(a,b){if(this.listeners[a]instanceof Array){var c=this.listeners[a].indexOf(b);c!==-1&&this.listeners[a].splice(c,1)}},a.EventEmitter.prototype.emit=function(a,b){b=b||{};if(this.listeners[a]instanceof Array){var c=this.listeners[a].length;for(var d=0;d<c;d+=1)this.listeners[a][d](this,b)}}}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.ObservableCollection=function(){this.listeners={},this.items=[]},a.ObservableCollection.inheritFrom(a.EventEmitter),a.ObservableCollection.prototype.at=function(b){return(b<0||b>=this.items.length)&&a.report("Index out of bounds"),this.items[b]},a.ObservableCollection.prototype.has=function(a){return this.items.indexOf(a)>=0},a.ObservableCollection.prototype.count=function(){return this.items.length},a.ObservableCollection.prototype.add=function(a){return this.has(a)||(this.items.push(a),this.emit("add",a)),this},a.ObservableCollection.prototype.remove=function(a){var b=this.items.indexOf(a);return b>=0&&(this.items.splice(b,1),this.emit("remove",a)),this},a.ObservableCollection.prototype.sortBy=function(a){return this.items.sort(a),this.emit("change"),this},a.ObservableCollection.prototype.orderBy=function(a,b){return this.sortBy(function(c,d){var e=0,f=a(c),g=a(d);return f>g?1:(f<g&&(e=-1),b?-e:e)})},a.ObservableCollection.prototype.each=function(a){for(var b=0;b<this.items.length;b+=1)a(this.items[b])},a.ObservableCollection.prototype.any=function(a){var b=this.by(a);return b?!0:!1},a.ObservableCollection.prototype.by=function(b){for(var c=0;c<this.items.length;c+=1){typeof b!="function"&&a.report("Predicate should be function");if(b(this.items[c]))return this.items[c]}return null},a.ObservableCollection.prototype.notify=function(a){this.on("change",a)},a.ObservableCollection.prototype.ignore=function(a){this.off("change",a)}}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.ObservableProperty=function(a){this.value=a,this.listeners={}},a.ObservableProperty.inheritFrom(a.EventEmitter),a.ObservableProperty.prototype.get=function(){return this.value},a.ObservableProperty.prototype.set=function(a){this.value!==a&&(this.value=a,this.emit("change"))},a.ObservableProperty.prototype.notify=function(a){this.on("change",a)},a.ObservableProperty.prototype.ignore=function(a){this.off("change",a)}}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.BaseModel=function(a,b){},a.BaseModel.prototype.assign=function(b){typeof b!="object"&&a.report("Properties should be object");for(var c in b)b.hasOwnProperty(c)&&this[c]instanceof a.ObservableProperty&&this[c].set(b[c])},a.BaseModel.prototype.newId=function(b){return typeof b!="number"?a.report("ID should be number"):b<0?a.report("ID should be positive"):b!==Math.floor(b)&&a.report("ID should be integer"),b},a.BaseModel.prototype.newProp=function(b){return new a.ObservableProperty(b)}}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.BaseView=function(){this.listeners={},this.isVisible=!1},a.BaseView.inheritFrom(a.EventEmitter),a.BaseView.prototype.renderTo=function(a){return this.parentNode=a,this.show()},a.BaseView.prototype.show=function(){return this.isVisible||(this.parentNode||a.report("Parent node unknown. Call renderTo() first."),this.parentNode.appendChild(this.node),this.isVisible=!0),this},a.BaseView.prototype.hide=function(){if(this.isVisible&&this.parentNode){try{this.parentNode.removeChild(this.node)}catch(a){}this.isVisible=!1}}}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.Poll=function(a,b){this.url=a,this.callback=b,this.minTiming=30,this.maxTiming=1e3,this.cacheSize=10,this.timingCache=[],this.isStarted=!1},a.Poll.prototype.start=function(){return this.isStarted||(this.isStarted=!0,this.runLoop()),this},a.Poll.prototype.stop=function(){return this.isStarted=!1,this},a.Poll.prototype.runLoop=function(){var a=this;this.request();var b=0;this.timingCache.forEach(function(a){b+=a});var c=b>0?b/this.timingCache.length:0,d=Math.min(Math.max(this.minTiming,c),this.maxTiming);this.isStarted&&setTimeout(function(){a.runLoop()},d)},a.Poll.prototype.request=function(){var b=this,c=new Date;$.ajax(this.url,{crossDomain:!0,dataType:"jsonp"}).done(function(a){var d=new Date,e=d-c;b.timingCache.push(e),b.timingCache.length>b.cacheSize&&b.timingCache.shift(),b.callback(a)}).fail(function(b){a.report("Request failed")})}}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.Transmitter=function(a,b){var c=this;this.baseUrl=a,this.actions=b||{};for(var d in b)b.hasOwnProperty(d)&&this.addMethod(d)},a.Transmitter.prototype.addMethod=function(a){var b=this;return b[a]=function(c){return b.send(a,c)},this},a.Transmitter.prototype.send=function(b,c){if(typeof this.actions[b]=="string"){var d=this.baseUrl+this.actions[b];return $.ajax({url:d,data:c,crossDomain:!0,dataType:"jsonp"}).fail(function(){a.report("Failed request to "+d)})}a.report("Can't find action "+b)}}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.UpdateInfo=function(b,c){this.created=[],this.changed=[],this.deleted=[];var d=this,e={};return b.forEach(function(b){var f=b.id;e[f]=f;var g=c.by(a.byId(f));if(g){var h=d.difference(b,g);h&&d.changed.push(h)}else d.created.push(b)}),c.each(function(a){e[a.id]===undefined&&d.deleted.push(a.id)}),d},a.UpdateInfo.prototype.difference=function(b,c){var d={id:b.id},e=!1;for(var f in b)b.hasOwnProperty(f)&&c[f]instanceof a.ObservableProperty&&c[f].get()!==b[f]&&(d[f]=b[f],e=!0);return e?d:null}}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.AppModel=function(){this.shapeModels=new a.ObservableCollection},a.AppModel.inheritFrom(a.BaseModel),a.AppModel.prototype.byId=function(a){return this.shapeModels.by(function(b){return b.id===a})},a.AppModel.prototype.hasId=function(a){return this.byId(a)?!0:!1},a.AppModel.prototype.save=function(b){var c=b.id,d=this.byId(c);d?d.assign(b):(d=new a.ShapeModel(c,b),this.shapeModels.add(d),console.log("created model "+c))},a.AppModel.prototype.remove=function(b){var c=this.byId(b);c?(this.shapeModels.remove(c),console.log("removed model "+b)):a.report("No model with id "+b)}}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.ShapeModel=function(b,c){this.id=this.newId(b),this.userId=this.newProp(a.userId),this.x=this.newProp(0),this.y=this.newProp(0),this.size=this.newProp(100),this.color=this.newProp("rgb(255, 0, 0)"),c!==undefined&&this.assign(c)},a.ShapeModel.inheritFrom(a.BaseModel)}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.AppView=function(b){var c=this;this.model=b,this.listeners={},this.isVisible=!1,this.shapeViews=new a.ObservableCollection,this.createButton=$("#createButton"),this.createButton.click(function(){c.emit("create")})},a.AppView.inheritFrom(a.BaseView)}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.ShapeView=function(b){var c=this,d=b;this.listeners={},this.isVisible=!1,this.model=b,this.parentNode=null,this.node=document.createElement("div"),this.node.innerHTML="test text",$(this.node).css("position","absolute"),$(this.node).css("border","1px solid #000000"),this.node.userId===a.userId&&$(this.node).draggable(),this.update()},a.ShapeView.inheritFrom(a.BaseView),a.ShapeView.prototype.update=function(){var a=$(this.node);a.css("background-color",this.model.color.get()),a.css("left",this.model.x.get()),a.css("top",this.model.y.get()),a.css("width",this.model.size.get()),a.css("height",this.model.size.get())}}(),function(){"use strict",window.sclient||(window.sclient={});var a=window.sclient;a.userId="Igor Zalutsky",a.baseUrl="http://eris.generation-p.com/test/",a.getAction="get-shapes.do",a.saveAction="save-shape.do",a.removeAction="remove-shape.do",a.squareSize=100,a.appModel=new a.AppModel,a.update=function(b){console.log(b);var c={};a.appModel.shapeModels.each(function(a){c[a.id]=a}),b.forEach(function(b){a.appModel.save(b),delete c[b.id]});for(var d in c)c.hasOwnProperty(d)&&a.appModel.remove(d)},a.pollUrl=a.baseUrl+a.getAction,a.poll=(new a.Poll(a.pollUrl,a.update)).start(),setTimeout(function(){a.poll.stop()},1e4),a.transmitter=new a.Transmitter(a.baseUrl,{save:a.saveAction,remove:a.removeAction}),$(document).ready(function(){a.appView=new a.AppView(a.appModel),a.appView.on("create",function(){a.transmitter.save({userId:a.userId,color:a.randomColor(),size:a.squareSize,x:a.randomInt(100,800),y:a.randomInt(100,600)})})})}();